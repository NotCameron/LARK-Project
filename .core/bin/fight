#!/bin/bash

monstFileName=$1

if [[ $1 != $(ls $PWD | grep -o $monstFileName 2>/dev/null) ]]; then
 echo "You can't fight that!"
 exit
elif [ $# -lt 1 ]; then
 echo "You can't fight nothing..."
 exit
elif [ $# -gt 1 ]; then
 echo "You can only fight one thing at a time!"
 exit
fi


printf "A $monstFileName approaches!\n"
echo "Your current inventory is: "
cat ~/LARK-Project/game/inventory

read -p "What weapon are you using? " wepName
while [[ "$(ls ~/LARK-Project/.core/modules/weapons/ | grep $wepName 2>/dev/null)" != $wepName  && -n "$wepName" ]]; do
 echo "That is not a weapon! If you don't have or want to use a weapon use your fist!"
 read -p "What weapon are you using? " wepName
done

read -p "What armor are you wearing? " armorName
while [[ "$(ls ~/LARK-Project/.core/modules/armor/ | grep $armorName 2>/dev/null)" != $armorName && -n "$armorName" ]]; do
 echo "That is not an armor! If you don't have or want to use armor type the word nothing"
 read -p "What armor are you wearing? " armorName
done

read -p "What accessory are you wearing? " accName
while [[ "$(ls ~/LARK-Project/.core/modules/accessories/ | grep $accName 2>/dev/null)" != $accName && -n "$accName" ]]; do
 printf "That is not an armor! If you don't have or want to use an accessory type the word nothing"
 read -p "What accessory are you wearing? " accName
done

source ~/LARK-Project/.core/modules/weapons/$wepName 2>/dev/null
source ~/LARK-Project/.core/modules/armor/$armorName 2>/dev/null
source ~/LARK-Project/.core/modules/accessories/$accName 2>/dev/null
source ~/LARK-Project/.core/modules/monsters/$monstFileName 2>/dev/null
source ~/LARK-Project/.core/playerStats 2>/dev/null

playerHP=$(($accHeal + $playerHP))
wepDam=$(($accDmg + $wepDam))
armorRate=$(($accArm + $armorRate))

trueMonstDam=$(($monstDam - $armorRate))
if [ $trueMonstDam -lt 1 ]; then
 trueMonstDam=1
fi

while [ $monstHP -gt 0 ] && [ $playerHP -gt 0 ]; do
 echo "Your current HP is: $playerHP"
 printf "What will you do? \n a) Attack   b) Use Potion   c) Run\n"
 read action
 case $action in
  a|A)
   echo "You strike the monster with your $wepName for $wepDam damage!"
   monstHP=$(($monstHP - $wepDam))
   if [ $monstHP -gt 0 ]; then
    echo "$monstName strikes you for $monstDam resisted by $armorRate"
    playerHP=$(($playerHP - $trueMonstDam))
   fi
  ;;
  b|B)
   echo "You take a drink from a health potion and feel rejuvenated!"
   playerHP=playerHP + 10;
  ;;
  c|C)
   echo "You flee from the $monstName!"
   break
  ;;
  *)
   echo "Invalid Input!"
  ;;
 esac
done

if [ $playerHP -le 0 ]; then
  echo "You blackout!"
  cd ..
  echo "You wake up just outside the room you were in."
elif [ $monstHP -le 0 ]; then
  echo "You've slain the $monstName!"
  if [[ $monstLoot ]]; then
    echo "Looks like the $monstName had some loot!"   
    mkdir chest
    touch chest/$monstLoot
    cd chest
    additem $monstLoot
    cd ..
    rm -r chest  
   fi
  if [[ $monstScroll != '' ]]; then
    touch Scroll
    echo $monstScroll > Scroll
    echo "The $monstName seems to have been holding onto a scroll..."
  fi
  rm $monstFileName 2>/dev/null
fi
